---
layout: post
title: 本地客户端调起解决方案
date: 2014-05-23 11:24:07.000000000 +08:00
categories:
- FE
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  duoshuo_thread_id: '1203060334345060396'
author:
  login: C1avie
  email: 429465251@qq.com
  display_name: C1avie
  first_name: ''
  last_name: ''
---
<p>最近做了一个本地客户端调起方案的调研，收获不少，总结一下,这里先不收调起协议之类的事。</p>
<p>先说下之前的方案：</p>
<p>Iphone：直接吊起以及暴力弹框。如果没有调起客户端，则出现弹框。如果成功调起客户端，则返回到页面中时触发pageshow事件，消除弹框。不过IOS uc浏览器不支持这个事件，因此返回到页面中时弹框会出现。</p>
<p>Android及其它：首先检测是否安装了客户端。如果安装了的话，则调起本地客户端。如果没有安装，则提供下载。由于检测是否安装了客户端的成功率不高，即可能用户已经安装了客户端，但是没有检测出来。所以需要改进。</p>
<p><code lang="javascript"><br />
if (util.isIPhone()) {<br />
me.appbutton.html('点击打开手机地图，省90%流量');<br />
util.bindHrefStat(me.appbutton, function() {<br />
$(document.body).append("<iframe id="callapp" style="border: 0; display: none;" src="baidumap://map/" width="0" height="0">");<br />
window.a = setTimeout(function() {<br />
util.DownBox.showTb();<br />
}, 1500);<br />
return false;<br />
});<br />
} else {<br />
me.appbutton.attr('data', util.getClientUrl('download'));<br />
util.isInstalledClient(function(openurl) {<br />
me.appbutton.html('点击打开手机地图，省90%流量').attr('data', util.getNativeUrl());<br />
me.appbutton.addClass("open");<br />
util.bindHrefStat(me.appbutton, function() {<br />
pbstat.addStat(COM_PB_STAT.TOP_BANNER, "click", {<br />
is_install_clientapp: true,<br />
os: me.os<br />
});<br />
});<br />
}, function(downloadurl) {<br />
me.appbutton.html($info).attr('data', downloadurl);<br />
util.bindHrefStat(me.appbutton, function() {<br />
pbstat.addStat(COM_PB_STAT.TOP_BANNER, "click", {<br />
is_install_clientapp: false,<br />
os: me.os<br />
});<br />
});<br />
}, me.appbutton.attr('uid'));</p>
<p>}<br />
</iframe></code></p>
<p>&nbsp;<br />
中间的策略：</p>
<p>IOS与Android都是直接调起以及暴力弹框，为支持android的uc和默认浏览器，新绑定了blur事件和visibilitychange事件。成功解决了android上uc和默认浏览器的显示问题。但是遗憾的是IOS uc浏览器对这几个事件都不支持。只能再想解决方案。</p>
<p>参考资料：</p>
<p>用户离开页面和回到页面事件（标签切换）</p>
<p><a href="http://blog.csdn.net/do_it__/article/details/6983239">http://blog.csdn.net/do_it__/article/details/6983239</a></p>
<p>html5 page visibility</p>
<p><a href="http://jackyrong.iteye.com/blog/1300764">http://jackyrong.iteye.com/blog/1300764</a></p>
<p>&nbsp;</p>
<p>现在的解决方案：</p>
<p>看了贴吧那边的webapp，在IOS下调起方案很好，不过他们在android下兼容性好像不行，都是直接下载的,无论安装客户端与否。于是找永霞联系了下贴吧那边的技术人员，并参阅了一些资料，找到了解决方案。</p>
<p>Iphone下采用一个计时策略，如果调起了客户端，则时间会大于2000毫秒，不提供下载。如果没有调起，时间会小于2000毫秒，提供下载链接.</p>
<p>测试情况：如果安装了对应的客户端，则浏览器均能打开应用；如果未安装，safari会首先弹出一个错误提醒，然后调用widow.location的代码，uc直接调用window.location这行代码。</p>
<p>Android则是直接调起与暴力弹框，调起客户端回到页面中时通过触发事件消除弹框。</p>
<p><code lang="javascript"><br />
me.appbutton.html('点击打开手机地图，省90%流量');<br />
if(util.isIPhone()) {<br />
util.bindHrefStat(me.appbutton, function() {<br />
$(document.body).append("<iframe src="baidumap://map/" id="callapp" width="0" height="0" style="border: 0;display: none;">");<br />
var clickedAt = +new Date;<br />
setTimeout(function(){<br />
!window.document.webkitHidden && setTimeout(function(){<br />
if (+new Date - clickedAt < 2000){<br />
window.location = 'http://itunes.apple.com/cn/app/id452186370?ls=1&mt=8';<br />
}<br />
}, 500);<br />
}, 500)<br />
return false;<br />
});<br />
}<br />
else {<br />
util.bindHrefStat(me.appbutton, function() {<br />
$(document.body).append("<iframe src="baidumap://map/" id="callapp" width="0" height="0" style="border: 0;display: none;">");<br />
window.a = setTimeout(function() {<br />
util.DownBox.showTb();<br />
}, 1500);</p>
<p>return false;<br />
});<br />
}<br />
</iframe></iframe></code></p>
<p>参考资料：<br />
<a href="http://liushuibird.blog.163.com/blog/static/1241915612013810113326699/">http://liushuibird.blog.163.com/blog/static/1241915612013810113326699/</a></p>
<p>项目Demo(限内网):<br />
<a href="http://cp01-rdqa-dev010.cp01.baidu.com:8088/mobile/webapp/index/index">http://cp01-rdqa-dev010.cp01.baidu.com:8088/mobile/webapp/index/index</a></p>
<p>&nbsp;</p>
